# VPCとsubnetにサーバを設置する

## VPCの作成
- 全体のネットワーク空間
- 今回はVPCウィザードを使わないで 「VPCを作成」から作る
- nameを設定
- ipv4 cidrのみ設定
  * 172.31.0.0/16(推奨レンジ)
  * ipアドレスのイメージ

## サブネットの作成
- VPCの中にサブネットを作れる
* 先程作成したVPCに紐付けて作成
* ipv4 cidrのみ設定
  * 172.31.0.0/24と172.31.1.0/24で作成(推奨レンジ)
- リージョン内のAZ毎に設定できる

## インターネットゲートウェイ
- VPCをインターネットに接続する
- nameのみ設定

## ルートテーブル
- パケットがどこに向かえばいいかを定義
- VPC作成時に1つ作成される
  - VPC内の通信ができるように定義されている
- サブネットに紐付けができる(メインのルートテーブルを設定)
- インターネットGWを設定
  - 送信先を0.0.0.0/0でどこでも送信できるようにする
  - ターゲットをインターネットGWにする

## サブネットのパブリックip自動割当有効化
- サブネットに属するインスタンスに自動でパブリックipが割り当てられる
- デフォルトのVPCではこれが有効化されているため、何も考えずにEC2を作ったときにパブリックIPが使える

## EC2インスタンスを2つ作成(パブリックとプライベート)
- 上記の割り当てが有効化されているサブネットに属するEC2インスタンスと、無効化されているサブネットのEC2インスタンスを作成
- パブリックIPが入っている方をWEBサーバとして、そうでない方をプライベートサーバとする

## セキュリティグループを作成
- publicはssh、http、httpsの0.0.0.0/0でインターネット通信を全許可
- privateはssh、http、https、mysql、icmpをpublicのサブネットipで切る(パブリックのサーバのみと通信できるようにする)

## パブリックサーバからプライベートにpingを飛ばす
- 疎通確認

## パブリックサーバに秘密鍵をコピー
- EC2サーバにアクセスするのと同じ

## 権限設定
chmod 400 private_key.pem

## NATゲートウェイを作成
- プライベートipとパブリックipを切り替える
  - インターネットに直接アクセスしないプライベートサブネットから、インターネット接続できるようにする
- パブリック側のサブネットに紐付ける
- ipを割り当てる(Elastic IP)→有料

## NATゲートウェイをルートテーブルに関連付け(プライベート側)
- プライベート側のルートテーブルにNATゲートウェイを追加
  - パブリック側に設置したNATテーブルにルーティングできるようにする
  - 送信先を0.0.0.0/0でどこでも送信できるようにする
  - ターゲットを作成したNATゲートウェイにする
