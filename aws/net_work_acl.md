# ネットワークACLを設定してみる
## ネットワークACLとは
- サブネットのインバウンドトラフィックとアウトバウンドトラフィックを制御するファイアウォール

## セキュリティグループとの違い
### セキュリティグループ
- インスタンスレベルで動作する
- ルールの許可のみがサポートされる
- ステートフル: ルールに関係なく、返されたトラフィックが自動的に許可される
- トラフィックを許可するかどうかを決める前に、すべてのルールを評価する
- インスタンスの起動時に誰かがセキュリティグループを指定した場合、または後でセキュリティグループをインスタンスに関連付けた場合にのみ、インスタンスに適用される

### ネットワークACL
- サブネットレベルで動作する
- ルールの許可と拒否がサポートされる
- ステートレス: 返されたトラフィックがルールによって明示的に許可される
- トラフィックを許可するかどうかを決定する際に、最も低い番号のルールから順にルールを処理する。
- 関連付けられているサブネット内のすべてのインスタンスに自動的に適用される

## 事前準備
- VPCとサブネットの作成
- EC2インスタンスを作成してapachを入れる
- パブリックipにアクセスしてhtmlファイルが開けることを確認

## デフォルト設定
  - 作成されたVPC-サブネットに紐付いている
  - 番号順にACLの設定を評価していき、どこかでヒットしたら許可 or 拒否が適用される
  - インバウンド、アウトバウンドともに100番で全てのトラフィックが許可されている
  - いずれの設定にも引っかからない場合、最後にすべての通信がdenyされる設定が入っている(暗黙のdeny)

## ネットワークACLを作成
- 名前を設定
- 紐付けるVPCを設定

## ルールを追加
### インバウンド
- 100: ssh 0.0.0.0/0 allow(すべての送信元に許可)
- 110: http 0.0.0.0/0 allow(すべての送信元に許可)
- 120: https 0.0.0.0/0 allow(すべての送信元に許可)

### アウトバウンド
- 100: http 0.0.0.0/0 allow(すべての送信先を許可)
- 110: https 0.0.0.0/0 allow(すべての送信先を許可)
- 120: カスタムTCP ポート:1024-65535 0.0.0.0/0 allow(全ての送信先を許可)
  * エファメラルポート
  - 用途が決まっていないポート
  - ipが固定されていない通常のPCからアクセスできるようにする

## サブネットを紐付け
- サブネットの関連付けから設定
- 関連付けされているサブネットが変わることを確認

## 検証
### 設定した内容で通信できるか
- EC2のパブリックipにアクセスできることを確認
### 設定を変えてみる①
- インバウンド
  - 100をhttp全許可をに変更
  - 101にhttp 自分のpcのパブリックipのみをdenyに設定
→100の許可でキャッチしているのでアクセスできる
### 設定を変えてみる②
- 上記の101を99に変える
→99の設定でdenyされているのでアクセスできない
別の端末でipを入力するとアクセスできる
